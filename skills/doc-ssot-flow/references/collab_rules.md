# AI 软件工程协作指令集

## 1. 基础协作与编码规范

- 文件标准：全中文交互；统一 UTF-8 (无 BOM)；doc/ 为文档根目录。
- 编码风格-强逻辑块：if/for/while 即使单行也必须使用大括号 {}。
- 编码风格-空行约束：} 独占一行后必空行；属性/方法定义间必空行；逻辑块内少空行。
- 编码风格-注释格式：符号与内容间保留一个空格（如 // 123）。

## 2. 文档体系核心（SSOT）

遵循单一事实源原则，采用生长-修剪策略（增量补全、删除过时、禁止内部版本号）。

### 2.1 全局技术报告（doc/project.md）

定位：项目的唯一技术基准。任何新人仅凭阅读此文件（假设删去所有任务文档）必须能无障碍接手项目。

硬性约束：
- 禁止空泛：严禁使用“高效”、“完善”等定性形容词。必须描述具体模式、库与流转逻辑。
- 结果导向：只记录最终方案与原因，严禁记录过程性内容。
- 模板强制：doc/project.md 必须严格按本节模板与顺序填写，大型项目不得缺项。

模板（必须完整填写）：

```md
#### 1. 全景

- 背景：业务场景、问题来源、现状痛点（可验证）。
- 核心目标：可验收结果清单（含衡量标准）。
- 非目标：明确不做的范围与边界（含排除理由）。
- 术语表：关键概念、缩写、外部系统代称与解释。

#### 2. 架构

- 架构总览：必须提供 Mermaid 的 C4 标准模块架构图，并说明模块边界、通信方式（同步/异步/事件）与部署形态。
- 模块清单：每个模块的职责、输入/输出、依赖、数据拥有权。
- 模块设计：每个核心模块必须提供关键 UML 设计图（类图/时序图/组件图，视模块而定）与对应的数据流说明。
- 外部依赖：第三方服务与基础设施，接口形态、SLA、降级策略。
- 关键接口：跨模块 API 或事件契约，含字段、校验规则、版本策略。

#### 3. 机制

- 数据流向：从来源到存储/输出的路径，关键转换与落库位置，标注读写边界。
- 关键算法：名称、输入、输出、复杂度约束、退化策略、可替代方案。
- 权限模型：角色、权限矩阵、授权流程、默认策略与最小权限原则。
- 状态机：核心对象状态列表、迁移条件、失败回滚策略与超时策略。
- 异常处理：错误分类、重试策略、幂等性、补偿机制与告警触发条件。

#### 4. 规约

- 目录结构：目录清单与用途，禁止的结构形态。
- 分支管理：分支类型、合并策略、发布流程与回滚入口。
- 技术栈约定：语言/框架/库版本与用途；禁止使用的组件与原因。
- 质量门槛：测试类型、覆盖率要求、静态检查清单与阻断策略。

#### 5. 运维与治理

- 监控与告警：关键指标、阈值、责任人、升级路径。
- 配置管理：环境变量、密钥管理、配置发布与审计流程。
- 审计与合规：日志保留策略、敏感数据处理、合规要求与稽核方式。
- 成本与容量：容量规划、扩容策略、成本边界与异常预警。

#### 6. 变更记录

- 变更摘要：变更原因、影响范围、回滚方案与验证方式。
- 依赖变更：新增/移除依赖与替代方案，含评估结论。
- 数据迁移：数据结构变更、迁移步骤、验证口径与回滚策略。
```

### 2.2 任务体系

#### A. 任务注册表（doc/tasks.md）

定位：进度仪表盘与索引。

内容：仅包含 ID、简述、优先级、状态（TODO/DOING/DONE）与文件链接。严禁包含技术细节。

模板（必须使用）：

```md
# 任务注册表

| ID | 简述 | 优先级 | 状态 | 文件 |
| --- | --- | --- | --- | --- |
| TODO | TODO | P1 | TODO | doc/task-xxx.md |
```

#### B. 单任务工作区（doc/task-xxx.md）

定位：增量开发的唯一工作台。任务一旦 DONE 即归档为历史快照，严禁回头修改。

强制结构：
- 需求（Requirements）：用户视角的行为描述（User Stories）与验收标准（DoD）。
- 约束：只描述用户可感知的状态与限制，禁止描述具体 UI 控件或布局。
- 设计（Design）：针对该任务的局部实现方案。
- 约束：在拆解 Issue 前，必须先在此定义模块 API 或接口契约。
- 测试（Tests）：必须定义测试范围与用例清单（单元/集成/端到端按需选择）。
- 执行记录（Execution Log）：以 Issue-xxx 为单位的追加式记录。
- 结构：必须包含 分析 -> 计划 -> 执行结果（成功/失败日志） -> 结论。
- 时效：必须在执行中实时记录，严禁事后补记。
- 测试要求：每个 Issue 必须记录测试范围与结果（单元/集成/端到端，按实际需要选择）。

模板（必须使用）：

```md
# 任务：TODO

## 需求（Requirements）

用户故事：
- TODO

验收标准（DoD）：
- TODO

非目标（Non-goals）：
- TODO

## 设计（Design）

模块/接口契约：
- TODO

## 测试（Tests）

测试范围：
- TODO

测试用例：
- TODO

## 执行记录（Execution Log）

### Issue-001

分析：
- TODO

计划：
- TODO

执行结果：
- 成功日志：
- 失败日志：

结论：
- TODO
```

## 3. 开发执行流程

### 3.1 准备与设计

- DDD 主导：以领域模型为核心拆解模块与边界，优先明确聚合、实体、值对象与领域服务。
- DDD 闭环：任何领域模型或边界调整，必须回写 doc/project.md 的架构与机制部分。
- 边界定义：PM/架构师必须在 task-xxx.md 中明确非目标（Non-goals）与验收标准。
- 全局同步：若涉及全局性变更（新模块/接口/数据流），必须先回写 project.md，否则任务不可结束。
- 环境守卫：若目录未初始化 Git，必须优先提示 git init。

### 3.2 编码与验证（Developer）

- Issue 驱动：在 task-xxx.md 中拆解 issue-xxx，严格执行红-绿-重构（TDD）。
- TDD 辅助：测试用例围绕领域规则与边界场景建立，优先覆盖关键业务不变量。
- 证据化存档-实时记录：分析、计划、尝试、结论必须在执行过程中实时写入，严禁事后补记。
- 证据化存档-文档优先：若 Task 记录缺失，必须先补齐文档再提交代码。
- 提交规范-来源：Commit Message 必须摘录自文档内的 Issue 总结，严禁先改代码后倒推。
- 提交规范-格式：<type>(task-xxx/issue-xxx): <description>。
- 提交规范-频率：每个 issue-xxx 完成即提交一次 Commit。

## 4. 交付与风控（Mandatory）

- 双重批准机制-任务验收：所有任务标记为 DONE 之前，必须提交成果并获得用户明确批准。
- 双重批准机制-颠覆性变更：涉及核心架构调整、数据流变更或单文件修改超过 30% 的重构，必须先说明理由并获显式批准。
- 回写熔断：任务结束前，必须检查是否产生全局性变更（如新模块/接口）。若有，必须先回写 project.md，否则禁止结项。
