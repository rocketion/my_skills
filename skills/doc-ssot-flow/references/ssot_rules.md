# AI 软件工程协作指令集

## 0. 适用范围与执行方式

- 适用范围：以 `doc/` 为文档根目录的工程协作与交付（含代码与文档变更）。
- 单一事实源（SSOT）：与工程相关的关键决策与约束，以 `doc/project.md` 为唯一技术基准；任务细节以 `doc/task-xxx.md` 为唯一工作台。
- 结项门槛：需要用户明确批准，且已完成 `doc/project.md` 闭环回写（如适用），否则禁止将任务标记为 DONE。

## 1. 基础协作与编码规范

- 文件标准：全中文交互；统一 UTF-8 (无 BOM)；doc/ 为文档根目录。
- 编码风格-强逻辑块：`if`/`for`/`while` 即使单行也必须使用大括号 `{}`。
- 编码风格-空行约束：} 独占一行后必空行；属性/方法定义间必空行；逻辑块内少空行。
- 编码风格-注释格式：符号与内容间保留一个空格（如 // 123）。

## 2. 文档体系核心（SSOT）

遵循单一事实源原则，采用生长-修剪策略（增量补全、删除过时、禁止内部版本号）。

### 2.1 全局技术报告（doc/project.md）

定位：项目的唯一技术基准。任何新人仅凭阅读此文件（假设删去所有任务文档）必须能无障碍接手项目。

硬性约束：
- 禁止空泛：严禁使用“高效”、“完善”等定性形容词。必须描述具体模式、库与流转逻辑。
- 结果导向：只记录最终方案与原因，严禁记录过程性内容。
- 模板约束：doc/project.md 必须按本节模板与顺序组织。标记为（可选）的章节可省略；未标记为（可选）的章节必须保留，不适用则写 N/A。
- 闭环约束（回写触发器）：满足任一即必须回写 `doc/project.md`。
  - 新增/删除模块，或模块职责发生变化。
  - 跨模块接口（API/事件契约）新增/修改/废弃。
  - 关键数据流向、存储边界、幂等/重试/补偿策略变化。
  - 权限模型、核心对象状态机、错误分类与告警策略变化。
  - 外部依赖（第三方服务/基础设施）新增/移除，或 SLA/降级策略变化。

模板（必须完整填写）：

```md
#### 1. 全景

- 背景：业务场景、问题来源、现状痛点（可验证）。
- 核心目标：可验收结果清单（含衡量标准）。
- 非目标：明确不做的范围与边界（含排除理由）。
- 术语表：关键概念、缩写、外部系统代称与解释。

#### 2. 架构

- 架构总览：必须提供 Mermaid 的 C4 标准模块架构图，并说明模块边界、通信方式（同步/异步/事件）与部署形态。
- 模块清单：每个模块的职责、输入/输出、依赖、数据拥有权。
- 模块设计：每个核心模块必须提供关键 UML 设计图（类图/时序图/组件图，视模块而定）与对应的数据流说明。
- 外部依赖：第三方服务与基础设施，接口形态、SLA、降级策略。
- 关键接口：跨模块 API 或事件契约，含字段、校验规则、版本策略。

#### 3. 机制

- 数据流向：从来源到存储/输出的路径，关键转换与落库位置，标注读写边界。
- 关键算法：名称、输入、输出、复杂度约束、退化策略、可替代方案。
- 权限模型：角色、权限矩阵、授权流程、默认策略与最小权限原则。
- 状态机：核心对象状态列表、迁移条件、失败回滚策略与超时策略。
- 异常处理：错误分类、重试策略、幂等性、补偿机制与告警触发条件。

#### 4. 规约

- 目录结构：目录清单与用途，禁止的结构形态。
- 分支管理：分支类型、合并策略、发布流程与回滚入口。
- 技术栈约定：语言/框架/库版本与用途；禁止使用的组件与原因。
- 质量门槛：测试类型、覆盖率要求、静态检查清单与阻断策略。

#### 5. 回归与事故

- 回归/反复问题清单：必须可追踪，禁止只写结论不写复现。
- 记录规则：
  - 首次发现必须登记为一条“回归项”。
  - 再次触发同一问题必须追加一条“触发记录”，不得覆盖或改写历史；并在关联的 `doc/task-xxx.md` 的对应 Issue 下补齐证据与处置结论。
  - 每条触发记录至少包含：触发条件、复现步骤（命令/操作）、证据（日志/截图摘要）、影响范围、处置状态、关联 task/issue（与 commit 如适用）。

（可选）#### 6. 运维与变更

- 运维：监控与告警、配置与密钥、审计与合规、容量与成本（不适用写 N/A）。
- 变更摘要：只记录“跨任务/跨模块”的里程碑变更；细节以任务文档为准。
```

### 2.2 任务体系

#### A. 任务注册表（doc/tasks.md）

定位：进度仪表盘与索引。

内容：仅包含 ID、简述、状态（TODO/DOING/DONE）与文件链接。严禁包含技术细节。

模板（必须使用）：

```md
# 任务注册表

| ID | 简述 | 状态 | 文件 |
| --- | --- | --- | --- |
| TODO | TODO | TODO | doc/task-xxx.md |
```

#### B. 单任务工作区（doc/task-xxx.md）

定位：增量开发的唯一工作台。任务一旦 DONE 即归档为历史快照，严禁回头修改。

硬性约束：
- 模板约束：必须按下方模板的章节顺序组织；不适用则写 N/A。
- 变更同步：Issue 的范围/方案/验证方式发生变化时，必须同步更新本 task 文档中的对应章节（需求/约束/设计/接口契约），禁止“只改执行日志不改任务定义”。
- 记录方式：执行记录必须以 Issue-xxx 为单位追加式记录，严禁事后补记。
- 测试归属：测试必须以 Issue 为单位定义与记录；每个 Issue 必须记录测试范围、验证步骤/命令与结果。
- 变更规则：Issue-xxx 未结项前允许调整计划与方案，但必须在该 Issue 下追加“变更”条目说明原因与影响；已结项 Issue 禁止改写，需要补充必须新增一个 Issue。

模板（必须使用）：

```md
# 任务：TODO

## 需求（Requirements）

说明：
- 用户故事：仅写用户视角行为，不写实现细节。
- 验收标准（DoD）：必须可验证，写清验证口径或步骤。
- 非目标：明确不做的范围与边界（含排除理由）。

用户故事：
- TODO

验收标准（DoD）：
- TODO

非目标（Non-goals）：
- TODO

## 约束（Constraints）

说明：
- 只描述用户可感知的状态与限制，禁止描述具体 UI 控件或布局。
- 必要时写清安全边界（只读源/操作区）与不可触碰的目录/仓库。

- 用户可感知约束：TODO
- 业务/安全边界：TODO

## 设计（Design）

说明：
- 只记录最终方案与原因；过程性尝试放在 Issue 执行记录里。
- 在拆解 Issue 前必须先定义模块 API 或接口契约。

模块/接口契约：
- TODO

## 执行记录（Execution Log）

### Issue-001

说明：
- 以追加方式记录；Issue 结束以“结论”为准。
- 计划/方案/验证方式发生变化时，在“变更”中说明原因与影响。

分析：
- TODO

计划：
- TODO

变更：
- TODO（若发生范围/方案/验证方式调整，记录原因与影响）

测试（Tests）：
- 测试范围：TODO
- 验证步骤/命令：TODO
- 结果：TODO

执行结果：
- 成功日志：
- 失败日志：

结论：
- TODO
```

## 3. 详细工作流（SOP）

定位：本节给出从启动到结项的详细执行步骤；具体内容写入本文件提供的模板章节中。

### 3.1 启动（Kickoff）

1. 明确范围：确认本次任务 ID（`task-xxx`）与初始 Issue（`Issue-001`）。
2. 明确边界：定义“只读源/操作区”，并在跨目录操作或脚本执行前确认只读源 Git 状态为 clean。
3. 先文档后代码：所有关键决策与约束先落到 `doc/` 再改代码。

### 3.2 初始化（Init）

1. 确认 `doc/` 存在；不存在则创建。
2. 维护 `doc/project.md`：按模板结构增量更新（不适用写 N/A）。
3. 维护 `doc/tasks.md`：登记任务索引（只写 ID/简述/状态/文件链接）。

### 3.3 任务定义（Task Definition）

1. 新建/更新 `doc/task-xxx.md`，按模板填写：
   - 需求（Requirements）：用户故事、DoD、非目标。
   - 约束（Constraints）：用户可感知约束与业务/安全边界（必要时写清只读源/操作区）。
   - 设计（Design）：先写最终方案与原因，并在拆 Issue 前定义模块/接口契约。
2. 若 Issue 的范围/方案/验证方式变化，必须同步更新上述任务定义（禁止只在执行日志里变更）。

### 3.4 Issue 循环（Per-Issue Loop）

对每个 Issue-xxx，按模板章节追加记录：

1. 分析：写清要解决的问题与影响面（不写过程性情绪或空泛结论）。
2. 计划：列出将要改动的文件/命令/验证步骤（文件级、命令级）。
3. 变更（如发生）：当计划/方案/验证方式调整时，追加写明原因与影响。
4. 测试：必须在 Issue 下记录测试范围、验证步骤/命令与结果（成功/失败都要记录证据）。
5. 实施与记录：执行修改；将关键成功/失败日志摘要写入“执行结果”。
6. 结论：给出最终结果与原因，并给出下一步 Issue 的边界（如适用）。
7. 提交：Issue 完成即提交一次；Commit Message 必须摘录自 Issue 结论，格式为 `<type>(task-xxx/issue-xxx): <description>`。

### 3.5 闭环与结项（Closeout）

1. 回写判断：若触发“回写触发器”，必须先回写 `doc/project.md`（否则禁止结项）。
2. 回归与事故：同一问题再次触发必须追加触发记录；已结项 Issue 禁止改写，需要补充必须新建 Issue。
3. 状态更新：更新 `doc/tasks.md` 中任务状态。
4. 最终验收：任务标记 DONE 前必须获得用户明确批准。

## 4. 执行检查表

定位：本节是执行期的强制检查清单（便于快速扫描）。具体写法以本文件中的模板与约束为准。

强制检查项：
- 环境边界：在任务开始时明确“只读源/操作区”；如涉及跨目录操作或脚本执行，必须先确认只读源 Git 状态为 clean。
- 文档优先：代码变更前必须有文档记录（至少落在 `doc/task-xxx.md` 的 Issue 下）。
- Issue 粒度：以 Issue-xxx 为最小执行单元，执行记录必须追加式记录，严禁事后补记。
- 变更同步：Issue 的范围/方案/验证方式变化，必须同步更新任务定义（需求/约束/设计/接口契约）并在 Issue 下追加“变更”。
- 测试归属：测试必须写在 Issue 下，并记录测试范围、验证步骤/命令与结果。
- 回归/事故：同一问题再次触发必须追加触发记录；已结项 Issue 禁止改写，需要补充必须新建 Issue。
- 提交规范：Commit Message 必须摘录自 Issue 结论，格式为 `<type>(task-xxx/issue-xxx): <description>`；每个 Issue 完成即提交一次。
- 闭环回写：触发“回写触发器”时，必须先回写 `doc/project.md`，否则禁止结项。

## 5. 交付与风控（Mandatory）

- 双重批准机制-任务验收：所有任务标记为 DONE 之前，必须提交成果并获得用户明确批准。
- 双重批准机制-颠覆性变更：涉及核心架构调整、数据流变更或单文件修改超过 30% 的重构，必须先说明理由并获显式批准。
- 回写熔断：任务结束前，必须检查是否产生全局性变更（如新模块/接口）。若有，必须先回写 project.md，否则禁止结项。
